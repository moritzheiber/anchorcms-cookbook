upstream <%= @resource.application.name %> {
  <% unless @application_socket.empty? -%>
    <% @application_socket.each do |socket_name| -%>
  server unix:<%= socket_name %>;
    <% end -%>
  <% end -%>
  <% @hosts.each do |node| %>
  server <%= node %>:<%= @resource.application_port %>;
  <% end %>
}

server {
  listen <%= @resource.port %>;
  server_name <%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>;
  <% if @resource.ssl %>
  ssl on;
  ssl_certificate <%= @resource.ssl_certificate %>;
  ssl_certificate_key <%= @resource.ssl_certificate_key %>;
  <% end %>
  <% @resource.static_files.each do |url, path| %>
  location <%= url %> {
    alias <%= path %>;
  }
  <% end %>
  location ~ .php5 {
    proxy_pass http://<%= @resource.application.name %>;
    <% if @resource.set_host_header %>
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    <% end %>
  }
}

location ~ /\. {
  deny all;
  access_log off;
  log_not_found off;
}

location / {
  index index.php;
  try_files $uri $uri/ @handler;
  expires 30d;
}

location @handler {
  rewrite / /index.php;
}

location ~ .php$ {
  fastcgi_pass   <%= node['nginx']['fpm_socket_path'] %>;
  fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
  include        fastcgi_params;
  
  fastcgi_param PHP_ADMIN_VALUE "memory_limit=512M
                               max_input_vars=30000
                               realpath_cache_size=32k
                               date.timezone='Europe/Berlin'";
}
